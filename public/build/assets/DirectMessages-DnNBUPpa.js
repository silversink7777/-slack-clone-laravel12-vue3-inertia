import{e as o,o as a,b as F,a as e,u as E,p as K,r as V,d as c,q as z,z as p,c as I,w as R,f as b,k as T,v as $,F as _,h as w,n as x,t as u,j as O,D as P,g as X}from"./app-B-MHB3Dy.js";import{_ as A}from"./WorkspaceSidebar-DSsTK3oG.js";const U={class:"h-screen"},L={class:"flex h-screen bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200"},H={class:"flex-1 flex flex-col"},Q={__name:"DirectMessagesLayout",props:{title:String},setup(C){return(i,d)=>(a(),o("div",U,[F(E(K),{title:C.title},null,8,["title"]),e("div",L,[F(A),e("div",H,[V(i.$slots,"default")])])]))}},G={class:"flex h-screen bg-gray-100 dark:bg-gray-900"},J={class:"w-80 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col h-full"},W={class:"p-4 border-b border-gray-200 dark:border-gray-700"},Y={class:"relative"},Z={key:0,class:"p-4 text-center"},ee={key:1,class:"flex-1 overflow-y-auto"},te={class:"p-2"},se=["onClick"],re={class:"flex items-center"},ae={class:"flex flex-col"},oe={class:"text-gray-900 dark:text-gray-100 font-medium"},le={class:"text-xs text-gray-500 dark:text-gray-400"},ne=["onClick"],ie={key:2,class:"flex-1 overflow-y-auto"},de={class:"p-2"},ce=["onClick"],ue={class:"flex flex-col"},ge={class:"text-gray-900 dark:text-gray-100 font-medium"},pe={key:0,class:"text-xs text-gray-500 dark:text-gray-400"},xe={key:3,class:"p-4 text-center"},me={class:"flex-1 flex flex-col h-full bg-gray-100 dark:bg-gray-900 min-h-0"},he={key:0,class:"flex-1 flex flex-col bg-gray-100"},ve={class:"p-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"},ye={class:"flex items-center justify-between"},fe={class:"flex items-center"},ke={class:"flex flex-col"},be={class:"text-lg font-semibold text-gray-900 dark:text-gray-100"},_e={key:0,class:"text-sm text-gray-500 dark:text-gray-400"},we={class:"flex-1 overflow-y-auto p-4 space-y-4 h-full min-h-0"},Ce={class:"text-sm"},Me={class:"text-xs mt-1 opacity-75"},je={class:"p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"},Se={class:"flex space-x-2"},Fe=["disabled"],Te={key:1,class:"flex-1 flex items-center justify-center"},Ne={__name:"DirectMessages",setup(C){const i=c(""),d=c([]),v=c(!1),m=c([]),n=c(null),h=c([]),g=c(""),f=c(null);let k=null;const B=()=>{k&&clearTimeout(k),k=setTimeout(()=>{i.value.trim()?D():d.value=[]},300)},D=async()=>{if(!i.value.trim()){d.value=[];return}v.value=!0;try{const r=document.head.querySelector('meta[name="csrf-token"]'),t={};r&&(t["X-CSRF-TOKEN"]=r.content);const s=await p.get("/users/search",{params:{q:i.value.trim()},headers:t});d.value=s.data.users||[]}catch(r){console.error("Failed to search users:",r),d.value=[]}finally{v.value=!1}},M=async r=>{try{const t=document.head.querySelector('meta[name="csrf-token"]'),s={Accept:"application/json","Content-Type":"application/json"};t&&(s["X-CSRF-TOKEN"]=t.content);const l=await p.post("/direct-messages/start",{partner_id:r.id,message:"こんにちは！"},{headers:s}),y={id:r.id,name:r.name,email:r.email,online:r.online};m.value.findIndex(q=>q.id===y.id)===-1&&m.value.unshift(y),await j(y),i.value="",d.value=[]}catch(t){console.error("Failed to start direct message:",t),alert("DMの開始に失敗しました。")}},j=async r=>{n.value=r,h.value=[];try{const t=document.head.querySelector('meta[name="csrf-token"]'),s={Accept:"application/json","Content-Type":"application/json"};t&&(s["X-CSRF-TOKEN"]=t.content);const l=await p.get(`/direct-messages/conversation?partner_id=${r.id}`,{headers:s});h.value=l.data}catch(t){console.error("Failed to fetch conversation:",t),h.value=[]}},S=async()=>{if(!(!g.value.trim()||!n.value))try{const r=document.head.querySelector('meta[name="csrf-token"]'),t={Accept:"application/json","Content-Type":"application/json"};r&&(t["X-CSRF-TOKEN"]=r.content);const s=await p.post("/direct-messages",{content:g.value.trim(),receiver_id:n.value.id},{headers:t});h.value.push(s.data),g.value=""}catch(r){console.error("Failed to send message:",r),r.response?(console.error("Error response:",r.response.data),r.response.status===405?alert("メッセージの送信方法が正しくありません。ページを再読み込みしてください。"):r.response.data&&r.response.data.error?alert(`メッセージの送信に失敗しました: ${r.response.data.error}`):alert("メッセージの送信に失敗しました。")):alert("メッセージの送信に失敗しました。")}},N=async()=>{try{const r=document.head.querySelector('meta[name="csrf-token"]'),t={};r&&(t["X-CSRF-TOKEN"]=r.content);const s=await p.get("/api/direct-messages/partners",{headers:t});m.value=s.data.map(l=>({id:l.id,name:l.name,email:l.email,online:l.online||!1}))}catch(r){console.error("Failed to load direct message partners:",r),m.value=[]}};return z(async()=>{try{const r=await p.get("/api/user");f.value=r.data.id}catch(r){console.error("Failed to get current user:",r)}await N()}),(r,t)=>(a(),I(Q,{title:"ダイレクトメッセージ"},{default:R(()=>[e("div",G,[e("div",J,[t[7]||(t[7]=e("div",{class:"p-4 border-b border-gray-200 dark:border-gray-700"},[e("div",{class:"flex items-center justify-between"},[e("h2",{class:"text-lg font-semibold text-gray-900 dark:text-gray-100"}," ダイレクトメッセージ "),e("a",{href:"/",class:"text-sm text-purple-600 dark:text-purple-400 hover:text-purple-800 dark:hover:text-purple-300 transition-colors",title:"トップ画面に戻る"},[e("svg",{class:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"})])])])],-1)),e("div",W,[e("div",Y,[T(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>i.value=s),onInput:B,type:"text",placeholder:"ユーザー名またはメールアドレスで検索...",class:"w-full px-3 py-2 pl-10 border border-gray-300 dark:border-gray-600 rounded-md text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-purple-500"},null,544),[[$,i.value]]),t[2]||(t[2]=e("svg",{class:"absolute left-3 top-2.5 h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1))])]),v.value?(a(),o("div",Z,t[3]||(t[3]=[e("svg",{class:"animate-spin h-6 w-6 mx-auto text-purple-500",fill:"none",viewBox:"0 0 24 24"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1),e("p",{class:"mt-2 text-sm text-gray-500 dark:text-gray-400"},"検索中...",-1)]))):d.value.length>0?(a(),o("div",ee,[e("div",te,[t[4]||(t[4]=e("h3",{class:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-2 px-2"},"検索結果",-1)),(a(!0),o(_,null,w(d.value,s=>(a(),o("div",{key:s.id,class:"flex items-center justify-between p-3 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer mb-1",onClick:l=>M(s)},[e("div",re,[e("span",{class:x(["h-3 w-3 rounded-full mr-3",{"bg-green-500":s.online,"bg-gray-400":!s.online}])},null,2),e("div",ae,[e("span",oe,u(s.name),1),e("span",le,u(s.email),1)])]),e("button",{onClick:O(l=>M(s),["stop"]),class:"px-3 py-1 bg-purple-600 text-white text-sm rounded hover:bg-purple-700 transition-colors"}," DM開始 ",8,ne)],8,se))),128))])])):(a(),o("div",ie,[e("div",de,[t[5]||(t[5]=e("h3",{class:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-2 px-2"},"最近の会話",-1)),(a(!0),o(_,null,w(m.value,s=>{var l;return a(),o("div",{key:s.id,class:x(["flex items-center p-3 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer mb-1",{"bg-purple-50 dark:bg-purple-900":((l=n.value)==null?void 0:l.id)===s.id}]),onClick:y=>j(s)},[e("span",{class:x(["h-3 w-3 rounded-full mr-3",{"bg-green-500":s.online,"bg-gray-400":!s.online}])},null,2),e("div",ue,[e("span",ge,u(s.name),1),s.email?(a(),o("span",pe,u(s.email),1)):b("",!0)])],10,ce)}),128))])])),i.value&&!v.value&&d.value.length===0?(a(),o("div",xe,t[6]||(t[6]=[e("p",{class:"text-gray-500 dark:text-gray-400"},"ユーザーが見つかりませんでした",-1)]))):b("",!0)]),e("div",me,[n.value?(a(),o("div",he,[e("div",ve,[e("div",ye,[e("div",fe,[e("span",{class:x(["h-3 w-3 rounded-full mr-3",{"bg-green-500":n.value.online,"bg-gray-400":!n.value.online}])},null,2),e("div",ke,[e("h3",be,u(n.value.name),1),n.value.email?(a(),o("span",_e,u(n.value.email),1)):b("",!0)])]),t[8]||(t[8]=e("a",{href:"/",class:"text-sm text-purple-600 dark:text-purple-400 hover:text-purple-800 dark:hover:text-purple-300 transition-colors",title:"トップ画面に戻る"},[e("svg",{class:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"})])],-1))])]),e("div",we,[(a(!0),o(_,null,w(h.value,s=>(a(),o("div",{key:s.id,class:x(["flex",s.sender_id===f.value?"justify-end":"justify-start"])},[e("div",{class:x(["max-w-xs lg:max-w-md px-4 py-2 rounded-lg",s.sender_id===f.value?"bg-purple-600 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100"])},[e("p",Ce,u(s.content),1),e("p",Me,u(s.time),1)],2)],2))),128))]),e("div",je,[e("div",Se,[T(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>g.value=s),onKeyup:P(S,["enter"]),type:"text",placeholder:"メッセージを入力...",class:"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-purple-500"},null,544),[[$,g.value]]),e("button",{onClick:S,disabled:!g.value.trim(),class:"px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed"}," 送信 ",8,Fe)])])])):(a(),o("div",Te,t[9]||(t[9]=[e("div",{class:"text-center"},[e("svg",{class:"mx-auto h-12 w-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})]),e("h3",{class:"mt-2 text-sm font-medium text-gray-900 dark:text-gray-100"},"ダイレクトメッセージ"),e("p",{class:"mt-1 text-sm text-gray-500 dark:text-gray-400"}," ユーザーを検索してDMを開始するか、最近の会話を選択してください "),e("div",{class:"mt-4"},[e("a",{href:"/",class:"inline-flex items-center px-4 py-2 bg-purple-600 text-white text-sm rounded-md hover:bg-purple-700 transition-colors"},[e("svg",{class:"h-4 w-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"})]),X(" トップ画面に戻る ")])])],-1)])))])])]),_:1}))}};export{Ne as default};
