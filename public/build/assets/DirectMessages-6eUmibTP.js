import{e as o,o as a,b as S,a as e,u as q,p as K,r as V,d as c,q as z,z as g,c as I,w as R,f as _,k as F,v as E,F as b,h as w,n as m,t as u,j as O,D as P,g as X}from"./app-CkYNA2PG.js";import{_ as A}from"./WorkspaceSidebar-DE7nfgqH.js";const U={class:"flex h-screen bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200"},L={class:"flex-1 flex flex-col"},H={__name:"DirectMessagesLayout",props:{title:String},setup(C){return(i,d)=>(a(),o("div",null,[S(q(K),{title:C.title},null,8,["title"]),e("div",U,[S(A),e("div",L,[V(i.$slots,"default")])])]))}},Q={class:"flex h-full"},G={class:"w-80 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col"},J={class:"p-4 border-b border-gray-200 dark:border-gray-700"},W={class:"relative"},Y={key:0,class:"p-4 text-center"},Z={key:1,class:"flex-1 overflow-y-auto"},ee={class:"p-2"},te=["onClick"],se={class:"flex items-center"},re={class:"flex flex-col"},ae={class:"text-gray-900 dark:text-gray-100 font-medium"},oe={class:"text-xs text-gray-500 dark:text-gray-400"},ne=["onClick"],le={key:2,class:"flex-1 overflow-y-auto"},ie={class:"p-2"},de=["onClick"],ce={class:"flex flex-col"},ue={class:"text-gray-900 dark:text-gray-100 font-medium"},pe={key:0,class:"text-xs text-gray-500 dark:text-gray-400"},ge={key:3,class:"p-4 text-center"},me={class:"flex-1 flex flex-col"},xe={key:0,class:"flex-1 flex flex-col"},ve={class:"p-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"},he={class:"flex items-center justify-between"},ye={class:"flex items-center"},fe={class:"flex flex-col"},ke={class:"text-lg font-semibold text-gray-900 dark:text-gray-100"},_e={key:0,class:"text-sm text-gray-500 dark:text-gray-400"},be={class:"flex-1 overflow-y-auto p-4 space-y-4"},we={class:"text-sm"},Ce={class:"text-xs mt-1 opacity-75"},Me={class:"p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"},je={class:"flex space-x-2"},Te=["disabled"],Se={key:1,class:"flex-1 flex items-center justify-center"},De={__name:"DirectMessages",setup(C){const i=c(""),d=c([]),h=c(!1),x=c([]),l=c(null),v=c([]),p=c(""),f=c(null);let k=null;const B=()=>{k&&clearTimeout(k),k=setTimeout(()=>{i.value.trim()?D():d.value=[]},300)},D=async()=>{if(!i.value.trim()){d.value=[];return}h.value=!0;try{const r=document.head.querySelector('meta[name="csrf-token"]'),t={};r&&(t["X-CSRF-TOKEN"]=r.content);const s=await g.get("/users/search",{params:{q:i.value.trim()},headers:t});d.value=s.data.users||[]}catch(r){console.error("Failed to search users:",r),d.value=[]}finally{h.value=!1}},M=async r=>{try{const t=document.head.querySelector('meta[name="csrf-token"]'),s={Accept:"application/json","Content-Type":"application/json"};t&&(s["X-CSRF-TOKEN"]=t.content);const n=await g.post("/direct-messages/start",{partner_id:r.id,message:"こんにちは！"},{headers:s}),y={id:r.id,name:r.name,email:r.email,online:r.online};x.value.findIndex(N=>N.id===y.id)===-1&&x.value.unshift(y),await j(y),i.value="",d.value=[]}catch(t){console.error("Failed to start direct message:",t),alert("DMの開始に失敗しました。")}},j=async r=>{l.value=r,v.value=[];try{const t=document.head.querySelector('meta[name="csrf-token"]'),s={Accept:"application/json","Content-Type":"application/json"};t&&(s["X-CSRF-TOKEN"]=t.content);const n=await g.get(`/direct-messages/conversation?partner_id=${r.id}`,{headers:s});v.value=n.data,setTimeout(()=>{window.dispatchEvent(new CustomEvent("dm-unread-count-updated"))},2e3)}catch(t){console.error("Failed to fetch conversation:",t),v.value=[]}},T=async()=>{if(!(!p.value.trim()||!l.value))try{const r=document.head.querySelector('meta[name="csrf-token"]'),t={Accept:"application/json","Content-Type":"application/json"};r&&(t["X-CSRF-TOKEN"]=r.content);const s=await g.post("/direct-messages",{content:p.value.trim(),receiver_id:l.value.id},{headers:t});v.value.push(s.data),p.value=""}catch(r){console.error("Failed to send message:",r),r.response?(console.error("Error response:",r.response.data),r.response.status===405?alert("メッセージの送信方法が正しくありません。ページを再読み込みしてください。"):r.response.data&&r.response.data.error?alert(`メッセージの送信に失敗しました: ${r.response.data.error}`):alert("メッセージの送信に失敗しました。")):alert("メッセージの送信に失敗しました。")}},$=async()=>{try{const r=document.head.querySelector('meta[name="csrf-token"]'),t={};r&&(t["X-CSRF-TOKEN"]=r.content);const s=await g.get("/api/direct-messages/partners",{headers:t});x.value=s.data.map(n=>({id:n.id,name:n.name,email:n.email,online:n.online||!1}))}catch(r){console.error("Failed to load direct message partners:",r),x.value=[]}};return z(async()=>{try{const r=await g.get("/api/user");f.value=r.data.id}catch(r){console.error("Failed to get current user:",r)}await $(),setTimeout(()=>{window.dispatchEvent(new CustomEvent("dm-unread-count-updated"))},2e3)}),(r,t)=>(a(),I(H,{title:"ダイレクトメッセージ"},{default:R(()=>[e("div",Q,[e("div",G,[t[7]||(t[7]=e("div",{class:"p-4 border-b border-gray-200 dark:border-gray-700"},[e("div",{class:"flex items-center justify-between"},[e("h2",{class:"text-lg font-semibold text-gray-900 dark:text-gray-100"}," ダイレクトメッセージ "),e("a",{href:"/",class:"text-sm text-purple-600 dark:text-purple-400 hover:text-purple-800 dark:hover:text-purple-300 transition-colors",title:"トップ画面に戻る"},[e("svg",{class:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"})])])])],-1)),e("div",J,[e("div",W,[F(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>i.value=s),onInput:B,type:"text",placeholder:"ユーザー名またはメールアドレスで検索...",class:"w-full px-3 py-2 pl-10 border border-gray-300 dark:border-gray-600 rounded-md text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-purple-500"},null,544),[[E,i.value]]),t[2]||(t[2]=e("svg",{class:"absolute left-3 top-2.5 h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1))])]),h.value?(a(),o("div",Y,t[3]||(t[3]=[e("svg",{class:"animate-spin h-6 w-6 mx-auto text-purple-500",fill:"none",viewBox:"0 0 24 24"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1),e("p",{class:"mt-2 text-sm text-gray-500 dark:text-gray-400"},"検索中...",-1)]))):d.value.length>0?(a(),o("div",Z,[e("div",ee,[t[4]||(t[4]=e("h3",{class:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-2 px-2"},"検索結果",-1)),(a(!0),o(b,null,w(d.value,s=>(a(),o("div",{key:s.id,class:"flex items-center justify-between p-3 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer mb-1",onClick:n=>M(s)},[e("div",se,[e("span",{class:m(["h-3 w-3 rounded-full mr-3",{"bg-green-500":s.online,"bg-gray-400":!s.online}])},null,2),e("div",re,[e("span",ae,u(s.name),1),e("span",oe,u(s.email),1)])]),e("button",{onClick:O(n=>M(s),["stop"]),class:"px-3 py-1 bg-purple-600 text-white text-sm rounded hover:bg-purple-700 transition-colors"}," DM開始 ",8,ne)],8,te))),128))])])):(a(),o("div",le,[e("div",ie,[t[5]||(t[5]=e("h3",{class:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-2 px-2"},"最近の会話",-1)),(a(!0),o(b,null,w(x.value,s=>{var n;return a(),o("div",{key:s.id,class:m(["flex items-center p-3 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer mb-1",{"bg-purple-50 dark:bg-purple-900":((n=l.value)==null?void 0:n.id)===s.id}]),onClick:y=>j(s)},[e("span",{class:m(["h-3 w-3 rounded-full mr-3",{"bg-green-500":s.online,"bg-gray-400":!s.online}])},null,2),e("div",ce,[e("span",ue,u(s.name),1),s.email?(a(),o("span",pe,u(s.email),1)):_("",!0)])],10,de)}),128))])])),i.value&&!h.value&&d.value.length===0?(a(),o("div",ge,t[6]||(t[6]=[e("p",{class:"text-gray-500 dark:text-gray-400"},"ユーザーが見つかりませんでした",-1)]))):_("",!0)]),e("div",me,[l.value?(a(),o("div",xe,[e("div",ve,[e("div",he,[e("div",ye,[e("span",{class:m(["h-3 w-3 rounded-full mr-3",{"bg-green-500":l.value.online,"bg-gray-400":!l.value.online}])},null,2),e("div",fe,[e("h3",ke,u(l.value.name),1),l.value.email?(a(),o("span",_e,u(l.value.email),1)):_("",!0)])]),t[8]||(t[8]=e("a",{href:"/",class:"text-sm text-purple-600 dark:text-purple-400 hover:text-purple-800 dark:hover:text-purple-300 transition-colors",title:"トップ画面に戻る"},[e("svg",{class:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"})])],-1))])]),e("div",be,[(a(!0),o(b,null,w(v.value,s=>(a(),o("div",{key:s.id,class:m(["flex",s.sender_id===f.value?"justify-end":"justify-start"])},[e("div",{class:m(["max-w-xs lg:max-w-md px-4 py-2 rounded-lg",s.sender_id===f.value?"bg-purple-600 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100"])},[e("p",we,u(s.content),1),e("p",Ce,u(s.time),1)],2)],2))),128))]),e("div",Me,[e("div",je,[F(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>p.value=s),onKeyup:P(T,["enter"]),type:"text",placeholder:"メッセージを入力...",class:"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-purple-500"},null,544),[[E,p.value]]),e("button",{onClick:T,disabled:!p.value.trim(),class:"px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed"}," 送信 ",8,Te)])])])):(a(),o("div",Se,t[9]||(t[9]=[e("div",{class:"text-center"},[e("svg",{class:"mx-auto h-12 w-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})]),e("h3",{class:"mt-2 text-sm font-medium text-gray-900 dark:text-gray-100"},"ダイレクトメッセージ"),e("p",{class:"mt-1 text-sm text-gray-500 dark:text-gray-400"}," ユーザーを検索してDMを開始するか、最近の会話を選択してください "),e("div",{class:"mt-4"},[e("a",{href:"/",class:"inline-flex items-center px-4 py-2 bg-purple-600 text-white text-sm rounded-md hover:bg-purple-700 transition-colors"},[e("svg",{class:"h-4 w-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"})]),X(" トップ画面に戻る ")])])],-1)])))])])]),_:1}))}};export{De as default};
